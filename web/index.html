<!DOCTYPE html>
<html>
<head>
	<title>Danger-Finger - Configure and Preview</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="stl_viewer.min.js"></script>
	<script src=
	"https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js">
		</script>
</head>
<body>
	<div id="wrap" style="width:100%; margin:0 auto;position:relative;">
		<div id="stl_cont" style="width:100%;visibility:hidden;border:1px dashed #202020;"></div>
		<img id="loader" style="position:absolute;top:150px;left:50%;margin-left:-193px;width:385px;height:42px;" >
	</div>

	<input type="text" id="model_info_cont" style="width:100%;">

	<table id="mdata">
		<tr id="mrow">
			<td id="preview"><input id="b_preview" type="button" value="Preview" onclick="add_models([0,1,2,3])"> </td>
			<td id="tip"><input id="b_tip" type="button" value="Tip" onclick="add_models([2]);"></td>
			<td id="middle"><input id="b_middle" type="button" value="Middle" onclick="add_models([1]); "></td>
			<td id="base"><input id="b_base" type="button" value="Base" onclick="add_models([0]);"></td>
			<td id="linkage"><input id="b_linkage" type="button" value="Linkage" onclick="add_models([3]);"></td>
		</tr>
		<tr id="mrow">
			<td id="params-basic"></td>
			<td id="params-basic"><input id="b_pb" type="button" value="Params: Basic" onclick="get_params('/params');"></td>
			<td id="params-basic"><input id="b_pbad" type="button" value="Params: Adv" onclick="get_params('/params/adv');"></td>
			<td id="params-basic"><input id="b_pba" type="button" value="Params: All" onclick="get_params('/params/all');"></td>
			<td id="params-basic"></td> <!--TODO show params as table, omit default matches feature?-->
		</tr>
		<!-- <tr id="mrow" >
			<td id="params_info" colspan="5"></td>
		</tr> -->
	</table>
	<p id="showData"></p>
<br />

	<script>
		var parts = {
			'0' : {'name': "base", 'pos': [0, 0, 0]},
			'1' : {'name': "middle", 'pos': [-30, 0, 0]},
			'2' : {'name': "tip", 'pos': [-60, 0, 0]},
			'3' : {'name': "linkage", 'pos': [50, 10, 0]},
		}
		var rotationx = 0;
		var rotationy = 0;
		var rotationz = 90;
		var url_template = "render/[NAME].stl";

		//convert from degrees to radians
		function degtorad(deg){ if (deg==0) {return 0; }else{return deg / 57.3;}}
		function button_name(id){ return "b_" + parts[id]['name'];}
		function file_name(id){ return url_template.replace('[NAME]', parts[id]['name']);}
		function $id(id){ return document.getElementById(id);}
		function model_clicked(model_id){ $id('model_info_cont').value=JSON.stringify(stl_viewer.get_model_info(model_id));}

		function do_resize(){
			var height = isNaN(window.innerHeight) ? window.clientHeight : window.innerHeight;
			var width = isNaN(window.innerWidth) ? window.clientWidth : window.innerWidth;
			$id('stl_cont').style.height = height * 0.4 + 'px';
		}

		function mod_loaded(){
			$id('loader').style.display='none';
			$id('stl_cont').style.visibility='visible';
			for (id in Object.keys(parts)){
				stl_viewer.set_position(id, parts[id]['pos'][0], parts[id]['pos'][1], parts[id]['pos'][2]);
			}
		}

		function add_models(ids){
			console.log(ids);
			document.getElementById("loader").src="loader.gif";
			for (k of ids){
				const id = parseInt(k)
				console.log("add" + id);
				const tdobj=$id(button_name(id));
				stl_viewer.add_model({'id': id, 'filename': file_name(id), 'rotationz': degtorad(rotationz)});
				tdobj.onclick = function() {rem_models([id]);}
			}
		}

		function rem_models(ids){
			console.log(ids);
			document.getElementById("loader").src="loader.gif";
			for (k of ids){
				const id = parseInt(k)
				console.log("rem" + id);
				const tdobj=$id(button_name(id));
				stl_viewer.remove_model(id);
				tdobj.onclick = function() {add_models([id]);}
			}
		}

		function model_drop(model_name){
			model_name=model_name.substring(0, model_name.lastIndexOf('.'));
			add_model(model_name, model_name, null, true);
		}

		function get_params(url) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					CreateTableFromJSON(JSON.parse( this.responseText));
				}
			};
			xhttp.open("GET", url, true);
			xhttp.setRequestHeader("Content-type", "application/json");
			xhttp.send("");
		}

		do_resize();
		var stl_viewer=new StlViewer(document.getElementById("stl_cont"),{
			auto_resize:true,
			zoom:100,
			allow_drag_and_drop:true,
			on_model_drop:model_drop,
			model_loaded_callback:mod_loaded,
			on_model_mousedown:model_clicked
		});

		function CreateTableFromJSON(dict) {
			var table = document.createElement("table");
			//first key is our parameter name, discover other headers
			var col = ['#', 'Parameter'];
			for (var k of Object.keys(dict)) {
				for (var key in dict[k]) {
					if (col.indexOf(key) === -1) { col.push(key); }
				}
			}

			// CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.
			var tr = table.insertRow(-1);                   // TABLE ROW.
			for (var i = 0; i < col.length; i++) {
				var th = document.createElement("th");      // TABLE HEADER.
				th.innerHTML = col[i];
				tr.appendChild(th);
			}

			// ADD JSON DATA TO THE TABLE AS ROWS.
			var c = 0;
			for (var k of Object.keys(dict)) {
				c++;
				tr = table.insertRow(-1);
				for (var j = 0; j < col.length; j++) {
					var tabCell = tr.insertCell(-1);
					if (j==0){
						tabCell.innerHTML = c;
					} else if (j==1){
						tabCell.innerHTML = k;
					}else{
						tabCell.innerHTML = dict[k][col[j]];
					}
				}
			}

			// FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
			var divContainer = document.getElementById("showData");
			divContainer.innerHTML = "";
			divContainer.appendChild(table);
		}

	</script>

</body>
</html>