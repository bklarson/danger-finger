<!---->
<!DOCTYPE html>
<html>
<head>
	<title>Danger-Finger - Configure and Preview</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="/stl_viewer.min.js"></script>
</head>
<!---->
<!--<script src="/stl_viewer.min.js"></script>-->
<body>
	<div id="wrap" style="width:100%; margin:0 auto;position:relative;">
		<div id="stl_cont" style="width:100%;visibility:hidden;border:1px dashed #202020;"></div>
		<img id="loader" style="position:absolute;top:150px;left:50%;margin-left:-193px;" >
	</div>

	<input type="text" id="model_info_cont" style="width:100%;">

	<table id="mdata">
		<tr id="mrow">
			<td id="preview">Part:</td>
			<td id="tip"><input id="b_tip" type="button" value="Tip" onclick=""></td>
			<td id="middle"><input id="b_middle" type="button" value="Middle" onclick=""></td>
			<td id="base"><input id="b_base" type="button" value="Base" onclick=""></td>
			<td id="linkage"><input id="b_linkage" type="button" value="Linkage" onclick=""></td>
		</tr>
		<tr id="mrow">
			<td id="params-basic">Parameters:</td>
			<td id="params-basic"><input id="b_ph" type="button" value="Hide" onclick="$id('advData').hidden = $id('showData').hidden = true;"></td>
			<td id="params-basic"><input id="b_pb" type="button" value="Standard" onclick="$id('advData').hidden = true; $id('showData').hidden = false;"></td>
			<td id="params-basic"><input id="b_pa" type="button" value="Advanced" onclick="$id('advData').hidden = false; $id('showData').hidden = true;"></td>
			<td id="params-basic">Explode:<br/><input type="range" min="0" max="100" value="0" class="slider" id="explode" oninput="slide_change();">
				<!--<br/>Rotate:<br/><input type="range" min="0" max="100" value="0" class="slider" id="rotate" oninput="slide_change();">-->
			</td> <!--TODO show params as table, omit default matches feature?-->
		</tr>
		<!-- <tr id="mrow" >
			<td id="params_info" colspan="5"></td>
		</tr> -->
	</table>
	<p id="showData"></p>
<br />
<p id="advData"></p>

	<script>
		baseurl = "";
		//baseurl = "http://ec2co-ecsel-qy18jthyyhk1-1448117639.us-east-1.elb.amazonaws.com:8081/";
		var parts = {
			'0' : {'name': "base", 'posf': [0, 0, 0], 'exp' : [0, 0, 0], 'pos': [0, 0, 0], 'rotf': [0, 0, 0] },
			'1' : {'name': "middle", 'posf': [-1, 0, 0], 'exp' : [-1, 0, 0], 'pos': [0, 0, 0], 'rotf': [0, 0, 1] },
			'2' : {'name': "tip", 'posf': [-2.1, 0, 0], 'exp' : [-2, 0, 0], 'pos': [0, 0, 0], 'rotf': [0, 0, 2] },
			'3' : {'name': "linkage", 'posf': [3, .85, 0], 'exp' : [0.5, 0.5, 0], 'pos': [0, 0, 0], 'rotf': [0, 0, 0] },
		}
		var rotationx = 0;
		var rotationy = 0;
		var rotationz = 0;
		var url_template = baseurl + "render/[NAME].stl";
		var extra_rotate = 0;
		const rot_factor = .65;
		const expl_factor = 25;
		var const_factor = 0;

		//convert from degrees to radians
		function degtorad(deg){ if (deg==0) {return 0; }else{return deg / 57.3;}}
		function button_name(id){ return "b_" + parts[id]['name'];}
		function file_name(id){ return url_template.replace('[NAME]', parts[id]['name']);}
		function $id(id){ return document.getElementById(id);}
		function model_clicked(model_id){ $id('model_info_cont').value=JSON.stringify(stl_viewer.get_model_info(model_id));}

		function do_resize(){
			var height = isNaN(window.innerHeight) ? window.clientHeight : window.innerHeight;
			var width = isNaN(window.innerWidth) ? window.clientWidth : window.innerWidth;
			$id('stl_cont').style.height = height * 0.4 + 'px';
		}

		function slide_change(){
			explode = $id('explode').value * expl_factor/100.0;
			//rotate = $id('rotate').value * rot_factor/100.0;
			for (id in Object.keys(parts)){
				stl_viewer.set_position(id,
					parts[id]['pos'][0] + parts[id]['exp'][0] * explode,
					parts[id]['pos'][1] + parts[id]['exp'][1] * explode,
					parts[id]['pos'][2] + parts[id]['exp'][2] * explode);
				// stl_viewer.rotate(id,
				// 	degtorad(parts[id]['rotf'][0] * rotate),
				// 	degtorad(parts[id]['rotf'][1] * rotate),
				// 	degtorad(parts[id]['rotf'][2] * rotate));
			}
		}

		function mod_loaded(){
			$id('loader').style.display='none';
			$id('stl_cont').style.visibility='visible';
			for (id in Object.keys(parts)){
				stl_viewer.set_position(id, parts[id]['pos'][0], parts[id]['pos'][1], parts[id]['pos'][2]);
			}
		}

		function add_models(ids){
			console.log(ids);
			document.getElementById("loader").src=baseurl + "loader.gif";
			for (k of ids){
				const id = parseInt(k)
				console.log("add" + id);
				const tdobj=$id(button_name(id));
				stl_viewer.add_model({'id': id, 'filename': file_name(id), 'rotationz': degtorad(rotationz)});
				tdobj.onclick = function() {rem_models([id]);}
			}
		}

		function rem_models(ids){
			console.log(ids);
			//document.getElementById("loader").src=baseurl + "loader.gif";
			for (k of ids){
				const id = parseInt(k)
				console.log("rem" + id);
				const tdobj=$id(button_name(id));
				stl_viewer.remove_model(id);
				tdobj.onclick = function() {add_models([id]);}
			}
		}

		function model_drop(model_name){
			model_name=model_name.substring(0, model_name.lastIndexOf('.'));
			add_model(model_name, model_name, null, true);
		}

		function get_params(url) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					//console.log("received params");
					params = JSON.parse( this.responseText)
					CreateTableFromJSON(params);
				}
			};
			xhttp.open("GET", baseurl + url, true);
			xhttp.setRequestHeader("Content-type", "application/json");
			xhttp.send("");
			//console.log("GET" + url);
		}

		do_resize();
		var stl_viewer=new StlViewer(document.getElementById("stl_cont"),{
			auto_resize:true,
			//zoom:-1,
			model_loaded_callback:mod_loaded,
			on_model_mousedown:model_clicked
		});

		var params = {}
		const hide_cols = ['Advanced', 'Hidden']

		function CreateTableFromJSON(dict) {
			var table = document.createElement("table");
			var tablea = document.createElement("table");
			//first key is our parameter name, discover other headers
			var col = ['#', 'Parameter'];
			for (var k of Object.keys(dict)) {
				for (var key in dict[k]) {
					if (col.indexOf(key) === -1 && hide_cols.indexOf(key) < 0) { col.push(key); }
				}
			}

			// CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.
			var tr = table.insertRow(-1);
			var tra = tablea.insertRow(-1);                   // TABLE ROW.
			for (var i = 0; i < col.length; i++) {
				var th = document.createElement("th");      // TABLE HEADER.
				th.innerHTML = col[i];
				tr.appendChild(th);

				var th2 = document.createElement("th");
				th2.innerHTML = col[i].replace("Parameter", "Advanced Parameter");
				tra.appendChild(th2);
			}

			// ADD JSON DATA TO THE TABLE AS ROWS.
			//var c = 0;
			for (var k of Object.keys(dict)) {
				if (dict[k]["Hidden"]){continue;}
				//c++;
				t = (dict[k]["Advanced"]) ? tablea : table;
				//tr = (dict[k]["Advanced"] != true) ? table.insertRow(-1) : tablea.insertRow(-1);
				tr = t.insertRow(-1);
				//console.log(dict[k]["Advanced"] + " " + tr.parentElement);
				for (var j = 0; j < col.length; j++) {
					var tabCell = tr.insertCell(-1);
					if (j==0){
						tabCell.innerHTML = t.rows.length-1;
					} else if (j==1){
						tabCell.innerHTML = k;
					} else if (col[j]=='Value'){
						tabCell.innerHTML = "<input name='" + k + "' id='" + k + "' value='" + dict[k][col[j]] + "' onchange='on_change(\"" + k + "\");' />";
					}else{
						tabCell.innerHTML = dict[k][col[j]];
					}
				}
				if (k=='intermediate_length'){
					const_factor = dict[k]['Value']/2 + 2;
					for (id in Object.keys(parts)){
						parts[id]['pos'] = [parts[id]['posf'][0] * const_factor, parts[id]['posf'][1] * const_factor, parts[id]['posf'][2] * const_factor];
					}
				}
				//slide_change();
			}

			// FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
			var divContainer = document.getElementById("showData");
			divContainer.innerHTML = "";

			var form = document.createElement("form");
			form.id = "form";
  			form.method = "POST";
    		form.action = "/profile/nick/config/test";
			divContainer.appendChild(form);
			form.appendChild(table);
			var button = document.createElement('button');
			button.innerHTML = 'Save';
			button.onclick = function(){submit();};
			divContainer.appendChild(button);

			//divContainer.appendChild(table);

			var div2 = document.getElementById("advData");
			div2.innerHTML = "";
			//div2.appendChild(document.createElement("br"));
			div2.appendChild(tablea);

			slide_change();
		}

		function submit(){
			for (k of Object.keys(params)){
				if (!params[k]["Changed"]){
					console.log(k);
					var i = $id(k);
					if (i){i.disabled = true;}
					//TODO create render button
				}
			}
			document.getElementById("form").submit();
		}

		function on_change(k){
			var v = $id(k).value = params[k]["Value"] = minmax($id(k).value, params[k]['Minimum'], params[k]['Maximum'])
			var chg = params[k]["Changed"] = (parseFloat(v) != parseFloat(params[k]["Default"]))
			console.log(k + ": " + JSON.stringify(params[k]) );
			$id(k).style.backgroundColor = chg ? "Green" : "";

			for (k of Object.keys(params)){
				if (params[k]["Changed"]){
					console.log(k)
					//TODO create render button
				}
			}

			//HACK
			// extra_rotate = v;
			// for (id in Object.keys(parts)){
			// 	stl_viewer.rotate(id, 0, 0, degtorad(rotationz + extra_rotate));
			// }

			//stl_viewer.stop_auto_zoom();
			//stl_viewer.set_camera(0, 0, v*3);
		}

		//TODO - create config call
		//TODO - reference config with model build

		function minmax(v, minv, maxv){
			var val = v;
			if (val < minv){ val = minv; }
			if (val > maxv){ val = maxv; }
			return val;
		}

		window.onload = function() {
			if (location.protocol != 'http:'){
				location.href = 'http:' + window.location.href.substring(window.location.protocol.length);
			}else{
				add_models([0,1,2,3]);
				get_params('/params/all');
			}};

	</script>

</body>
</html>